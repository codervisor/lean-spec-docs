#!/usr/bin/env bash

# leanspec - Manage LeanSpec documents
# Usage: ./leanspec <command> [args]

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATES_DIR="$(dirname "$SCRIPT_DIR")/spec-templates"
TEMPLATE_FILE="$TEMPLATES_DIR/template.md"

# Function to display main usage
usage() {
    echo "LeanSpec - Manage your LeanSpec documents"
    echo ""
    echo "Usage: $0 <command> [args]"
    echo ""
    echo "Commands:"
    echo "  create <name> [directory]     Create a new LeanSpec document"
    echo "  archive <spec-file> [reason]  Archive an existing LeanSpec document"
    echo "  list [directory] [--archived] List all LeanSpec documents"
    echo "  help                          Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 create user-export"
    echo "  $0 create user-export ./specs"
    echo "  $0 archive ./specs/LEANSPEC_old-feature.md 'Feature deprecated'"
    echo "  $0 list"
    echo "  $0 list ./src --archived"
    exit 1
}

# ============================================================
# CREATE COMMAND
# ============================================================
cmd_create() {
    if [ $# -lt 1 ]; then
        echo -e "${RED}Error: 'create' requires a name argument${NC}"
        echo "Usage: $0 create <name> [directory]"
        exit 1
    fi

    local NAME="$1"
    local TARGET_DIR="${2:-./specs}"

    # Check if template exists
    if [ ! -f "$TEMPLATE_FILE" ]; then
        echo -e "${RED}Error: Template file not found: $TEMPLATE_FILE${NC}"
        exit 1
    fi

    # Create target directory if it doesn't exist
    mkdir -p "$TARGET_DIR"

    # Generate filename
    local SPEC_FILE="$TARGET_DIR/LEANSPEC_${NAME}.md"

    # Check if spec already exists
    if [ -f "$SPEC_FILE" ]; then
        echo -e "${YELLOW}Warning: Spec file already exists: $SPEC_FILE${NC}"
        read -p "Overwrite? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 1
        fi
    fi

    # Copy template to new location
    cp "$TEMPLATE_FILE" "$SPEC_FILE"

    # Get current date
    local CURRENT_DATE=$(date +%Y-%m-%d)

    # Replace placeholders in the new spec
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        sed -i '' "s/\[Date\]/$CURRENT_DATE/g" "$SPEC_FILE"
    else
        # Linux
        sed -i "s/\[Date\]/$CURRENT_DATE/g" "$SPEC_FILE"
    fi

    echo -e "${GREEN}âœ“ Created new LeanSpec: $SPEC_FILE${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Open the file and fill in the template sections"
    echo "  2. Replace [bracketed] placeholders with your content"
    echo "  3. Adapt sections to fit your needs (add/remove as needed)"
    echo "  4. Commit the spec to version control"
    echo ""
    echo -e "${YELLOW}Remember: LeanSpec is about clarity, not completeness. Keep it lean!${NC}"
}

# ============================================================
# ARCHIVE COMMAND
# ============================================================
cmd_archive() {
    if [ $# -lt 1 ]; then
        echo -e "${RED}Error: 'archive' requires a spec file argument${NC}"
        echo "Usage: $0 archive <spec-file> [reason]"
        exit 1
    fi

    local SPEC_FILE="$1"
    local REASON="${2:-No reason provided}"

    # Check if spec file exists
    if [ ! -f "$SPEC_FILE" ]; then
        echo -e "${RED}Error: Spec file not found: $SPEC_FILE${NC}"
        exit 1
    fi

    # Get directory and filename
    local SPEC_DIR="$(dirname "$SPEC_FILE")"
    local SPEC_NAME="$(basename "$SPEC_FILE")"

    # Create archive directory
    local ARCHIVE_DIR="$SPEC_DIR/archived"
    mkdir -p "$ARCHIVE_DIR"

    # Generate archive filename with timestamp
    local TIMESTAMP=$(date +%Y%m%d)
    local ARCHIVE_FILE="$ARCHIVE_DIR/${SPEC_NAME%.md}_archived_${TIMESTAMP}.md"

    # If archive file already exists, add a counter
    local COUNTER=1
    while [ -f "$ARCHIVE_FILE" ]; do
        ARCHIVE_FILE="$ARCHIVE_DIR/${SPEC_NAME%.md}_archived_${TIMESTAMP}_${COUNTER}.md"
        COUNTER=$((COUNTER + 1))
    done

    # Copy the spec to archive
    cp "$SPEC_FILE" "$ARCHIVE_FILE"

    # Add archive header to the archived file
    local ARCHIVE_DATE=$(date +%Y-%m-%d)
    local ARCHIVE_HEADER="---
**ARCHIVED**: $ARCHIVE_DATE
**Reason**: $REASON
**Original Location**: $SPEC_FILE

This spec has been archived and should be considered historical documentation only.
For current specifications, refer to the active specs directory.

---

"

    # Prepend archive header
    echo "$ARCHIVE_HEADER" | cat - "$ARCHIVE_FILE" > "$ARCHIVE_FILE.tmp" && mv "$ARCHIVE_FILE.tmp" "$ARCHIVE_FILE"

    echo -e "${GREEN}âœ“ Archived spec: $ARCHIVE_FILE${NC}"
    echo ""
    echo "The original file is still at: $SPEC_FILE"
    echo ""
    read -p "Delete the original file? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm "$SPEC_FILE"
        echo -e "${GREEN}âœ“ Deleted original file${NC}"
    else
        echo -e "${YELLOW}Original file kept. You may want to delete it manually.${NC}"
    fi

    echo ""
    echo "Archive location: $ARCHIVE_FILE"
}

# ============================================================
# LIST COMMAND
# ============================================================
cmd_list() {
    local SEARCH_DIR="."
    local SHOW_ARCHIVED=false

    # Parse arguments
    for arg in "$@"; do
        case $arg in
            --archived)
                SHOW_ARCHIVED=true
                shift
                ;;
            --help|-h)
                echo "Usage: $0 list [directory] [--archived]"
                exit 0
                ;;
            *)
                if [ -d "$arg" ]; then
                    SEARCH_DIR="$arg"
                fi
                shift
                ;;
        esac
    done

    # Function to extract status from spec
    get_status() {
        local file="$1"
        local status=$(grep -i "^\*\*Status\*\*:" "$file" | head -1 | sed 's/.*Status\*\*: *//' | sed 's/\].*//' | sed 's/\[//')
        echo "${status:-Unknown}"
    }

    # Function to extract creation date
    get_created_date() {
        local file="$1"
        local date=$(grep -i "^\*\*Created\*\*:" "$file" | head -1 | sed 's/.*Created\*\*: *//')
        echo "${date:-Unknown}"
    }

    # Function to format spec entry
    format_spec() {
        local file="$1"
        local is_archived="$2"
        local rel_path="${file#$SEARCH_DIR/}"
        local status=$(get_status "$file")
        local created=$(get_created_date "$file")
        
        if [ "$is_archived" = true ]; then
            echo -e "${GRAY}  ðŸ“¦ $rel_path${NC}"
            echo -e "${GRAY}     Status: $status | Created: $created | ARCHIVED${NC}"
        else
            case "$status" in
                *Draft*)
                    echo -e "${YELLOW}  ðŸ“ $rel_path${NC}"
                    ;;
                *Progress*|*Active*)
                    echo -e "${BLUE}  ðŸš§ $rel_path${NC}"
                    ;;
                *Complete*|*Ready*)
                    echo -e "${GREEN}  âœ“ $rel_path${NC}"
                    ;;
                *)
                    echo -e "${CYAN}  ðŸ“„ $rel_path${NC}"
                    ;;
            esac
            echo -e "     Status: $status | Created: $created"
        fi
        echo ""
    }

    echo ""
    echo -e "${GREEN}=== LeanSpec Documents ===${NC}"
    echo ""

    # Find active specs
    local ACTIVE_SPECS=$(find "$SEARCH_DIR" -type f -name "LEANSPEC_*.md" ! -path "*/archived/*" ! -path "*/.git/*" 2>/dev/null | sort)

    if [ -z "$ACTIVE_SPECS" ]; then
        echo "No active LeanSpec documents found in $SEARCH_DIR"
    else
        echo -e "${CYAN}Active Specs:${NC}"
        echo ""
        while IFS= read -r spec; do
            [ -n "$spec" ] && format_spec "$spec" false
        done <<< "$ACTIVE_SPECS"
    fi

    # Find archived specs if requested
    if [ "$SHOW_ARCHIVED" = true ]; then
        local ARCHIVED_SPECS=$(find "$SEARCH_DIR" -type f \( -name "LEANSPEC_*_archived_*.md" -o -path "*/archived/LEANSPEC_*.md" \) 2>/dev/null | sort)
        
        if [ -n "$ARCHIVED_SPECS" ]; then
            echo ""
            echo -e "${GRAY}Archived Specs:${NC}"
            echo ""
            while IFS= read -r spec; do
                [ -n "$spec" ] && format_spec "$spec" true
            done <<< "$ARCHIVED_SPECS"
        fi
    fi

    # Summary
    local ACTIVE_COUNT=$(echo "$ACTIVE_SPECS" | grep -c "LEANSPEC_" 2>/dev/null || echo "0")
    if [ "$SHOW_ARCHIVED" = true ]; then
        local ARCHIVED_COUNT=$(find "$SEARCH_DIR" -type f \( -name "LEANSPEC_*_archived_*.md" -o -path "*/archived/LEANSPEC_*.md" \) 2>/dev/null | wc -l | tr -d ' ')
        echo ""
        echo -e "${CYAN}Total: $ACTIVE_COUNT active specs, $ARCHIVED_COUNT archived specs${NC}"
    else
        echo ""
        echo -e "${CYAN}Total: $ACTIVE_COUNT active specs${NC}"
        echo -e "${GRAY}(Use --archived flag to include archived specs)${NC}"
    fi

    echo ""
}

# ============================================================
# MAIN COMMAND DISPATCHER
# ============================================================

if [ $# -eq 0 ]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    create)
        cmd_create "$@"
        ;;
    archive)
        cmd_archive "$@"
        ;;
    list)
        cmd_list "$@"
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$COMMAND'${NC}"
        echo ""
        usage
        ;;
esac
